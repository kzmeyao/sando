---
import { Image } from "astro:assets";
import { GraphQLClient } from "graphql-request";
import Main from "../../layouts/main.astro";
import type { Set } from "../../generated/graphql";

export async function getStaticPaths() {
  const client = new GraphQLClient(import.meta.env.ASTRO_HYGRAPH_ENDPOINT);
  const { sets } = await client.request(`
    query Sets {
      sets {
        slug
      }
    }
  `);

  return sets.map((set: Set) => ({
    params: { slug: set.slug },
  }));
}

const { slug } = Astro.params;

const client = new GraphQLClient(import.meta.env.ASTRO_HYGRAPH_ENDPOINT);

const { set } = await client.request(
  `query Set($slug: String!) {
    set(where: {slug: $slug}) {
      displayTitle
      images {
        imageCaption
        url
        width
        height
      }
    }
  }`,
  { slug },
);
---

<Main content={{ title: set.displayTitle }}>
  {
    set.images.map(
      (
        image: {
          url: string;
          imageCaption: string;
          width: number;
          height: number;
        },
        index: number,
      ) => (
        <figure id={`image-${index}`} class="h-screen flex flex-col p-4">
          <div class="flex-1 min-h-0 flex items-center justify-center">
            <div class="min-h-0 max-h-full flex flex-col items-center">
              <img
                src={image.url}
                alt={image.imageCaption || ""}
                class="min-h-0 max-h-full max-w-full object-contain"
              />
              {image.imageCaption && (
                <figcaption class="flex-shrink-0 py-3 text-center text-sm text-neutral-600 font-serif">
                  {image.imageCaption}
                </figcaption>
              )}
            </div>
          </div>
          <nav class="flex-shrink-0 flex justify-center items-center gap-4 py-2 text-sm font-light">
            {index > 0 ? (
              <a
                href={`#image-${index - 1}`}
                class="text-neutral-600 hover:text-neutral-900 transition-colors"
              >
                &lt; PREV
              </a>
            ) : (
              <span class="text-neutral-300">&lt; PREV</span>
            )}
            <span class="text-neutral-300">|</span>
            <a
              href="/"
              class="text-neutral-600 hover:text-neutral-900 transition-colors"
            >
              HOME
            </a>
            <span class="text-neutral-300">|</span>
            {index < set.images.length - 1 ? (
              <a
                href={`#image-${index + 1}`}
                class="text-neutral-600 hover:text-neutral-900 transition-colors"
              >
                NEXT &gt;
              </a>
            ) : (
              <span class="text-neutral-300">NEXT &gt;</span>
            )}
          </nav>
          <div class="flex-shrink-0 flex justify-center gap-2 py-2">
            {set.images.map(
              (
                thumb: {
                  url: string;
                  imageCaption: string;
                  width: number;
                  height: number;
                },
                thumbIndex: number,
              ) => (
                <a href={`#image-${thumbIndex}`}>
                  <Image
                    src={thumb.url}
                    alt={thumb.imageCaption || ""}
                    class:list={[
                      "h-12 w-auto object-contain cursor-pointer transition-opacity",
                      thumb.url === image.url
                        ? "opacity-100"
                        : "opacity-50 hover:opacity-75",
                    ]}
                    width={Math.round((48 * thumb.width) / thumb.height)}
                    height={48}
                  />
                </a>
              ),
            )}
          </div>
        </figure>
      ),
    )
  }
</Main>
