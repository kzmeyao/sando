---
import { GraphQLClient } from "graphql-request";
import Main from "../../layouts/main.astro";
import type { Set } from "../../generated/graphql";
import { transformHygraphImage } from "../../utils";

export async function getStaticPaths() {
  const client = new GraphQLClient(import.meta.env.ASTRO_HYGRAPH_ENDPOINT);
  const { sets } = await client.request(`
    query Sets {
      sets {
        slug
      }
    }
  `);

  return sets.map((set: Set) => ({
    params: { slug: set.slug },
  }));
}

const { slug } = Astro.params;

const client = new GraphQLClient(import.meta.env.ASTRO_HYGRAPH_ENDPOINT);

const { set } = await client.request(
  `query Set($slug: String!) {
    set(where: {slug: $slug}) {
    date
      displayTitle
      images {
        imageCaption
        url
        width
        height
      }
    }
  }`,
  { slug },
);
---

<Main content={{ title: set.displayTitle }}>
  {
    set.images.map(
      (
        image: {
          url: string;
          imageCaption: string;
          width: number;
          height: number;
        },
        index: number,
      ) => (
        <figure id={`image-${index}`} class="h-screen flex flex-col p-4">
          <div class="flex-1 min-h-0 flex items-center justify-center md:py-4">
            <div class="min-h-0 max-h-full flex flex-col items-center">
              <img
                src={image.url}
                alt={image.imageCaption || ""}
                width={image.width}
                height={image.height}
                style={{ aspectRatio: `${image.width} / ${image.height}` }}
                class="min-h-0 max-h-[85vh] max-w-full object-contain opacity-0 transition-opacity duration-700 mx-auto"
                onload="this.classList.remove('opacity-0')"
              />
              {image.imageCaption && (
                <figcaption class="flex-shrink-0 py-4 text-center text-sm text-neutral-600 font-serif">
                  <h1 class="font-sans font-light mb-2 text-sm">
                    <span class="uppercase">
                      {set.displayTitle} [{new Date(set.date).getFullYear()}]
                    </span>
                  </h1>
                  <p class="text-xs">
                    {image.imageCaption}
                    <span class="italic">
                      ({index + 1} of {set.images.length})
                    </span>
                  </p>
                </figcaption>
              )}
            </div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <nav class="flex-shrink-0 items-center text-sm font-light">
              {index > 0 ? (
                <a
                  href={`#image-${index - 1}`}
                  class="text-neutral-600 hover:text-neutral-900 transition-colors"
                >
                  &lt; PREV
                </a>
              ) : (
                <span class="text-neutral-300">&lt; PREV</span>
              )}
              <span class="text-neutral-300">&nbsp;&nbsp;|&nbsp;&nbsp;</span>
              <a
                href="/"
                class="text-neutral-600 hover:text-neutral-900 transition-colors"
              >
                HOME
              </a>
              <span class="text-neutral-300">&nbsp;&nbsp;|&nbsp;&nbsp;</span>
              {index < set.images.length - 1 ? (
                <a
                  href={`#image-${index + 1}`}
                  class="text-neutral-600 hover:text-neutral-900 transition-colors"
                >
                  NEXT &gt;
                </a>
              ) : (
                <span class="text-neutral-300">NEXT &gt;</span>
              )}
            </nav>
            <div class="flex-shrink-0 gap-2">
              {set.images.map(
                (
                  thumb: {
                    url: string;
                    imageCaption: string;
                    width: number;
                    height: number;
                  },
                  thumbIndex: number,
                ) => (
                  <a href={`#image-${thumbIndex}`}>
                    <img
                      src={transformHygraphImage(thumb.url, 96)}
                      alt={thumb.imageCaption || ""}
                      width={96}
                      height={Math.round((96 * thumb.height) / thumb.width)}
                      style={{
                        aspectRatio: `${thumb.width} / ${thumb.height}`,
                      }}
                      class:list={[
                        "h-12 w-auto object-contain cursor-pointer transition-opacity",
                        thumb.url === image.url
                          ? "opacity-100"
                          : "opacity-50 hover:opacity-75",
                      ]}
                    />
                  </a>
                ),
              )}
            </div>
          </div>
        </figure>
      ),
    )
  }
</Main>
